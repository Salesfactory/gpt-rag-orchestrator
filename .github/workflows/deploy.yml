name: Deploy Python App to Azure Functions

on:
  push:
    branches:
      - develop

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Install Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Azure DevOps Extensions (azd)
        run: |
          az extension add --name azure-devops

      - name: Setup Azure Environment
        run: |
          az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          az config set defaults.location="east-us"
          azd env set --name "develop-clew"

      - name: Refresh environment
        run: azd env refresh

      - name: Deploy to Azure Functions
        run: azd deploy

      - name: Logout of Azure
        run: az logout
